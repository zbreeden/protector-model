<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Protector ‚Äî Fire & Safety Lens</title>
  <meta name="description" content="The Protector (Fire & Safety lens): monitor incidents, readiness, and response." />

  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1623; --border:#1f2937; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#60a5fa; --good:#10b981; --warn:#f59e0b; --bad:#ef4444; --shadow:0 8px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b0f14;color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #0f172a 0%, #0b0f14 60%, #06080c 100%);}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1080px;margin:0 auto;padding:24px}
    .topbar{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .back{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#0b111b;
      padding:8px 12px;border-radius:999px;color:var(--text)}
    .badge{margin-left:auto;color:var(--muted);font-size:.9rem}

    .hero{border:1px solid var(--border);border-radius:16px;padding:24px;background:linear-gradient(180deg, rgba(96,165,250,.12), rgba(96,165,250,.02));box-shadow:var(--shadow)}
    .hero h1{margin:0 0 6px 0;font-size:1.8rem}
    .hero p{margin:0;color:var(--muted)}
    .controls{display:flex;flex-wrap:wrap;gap:12px;margin-top:16px}
    .btn{background:var(--accent);color:#08111c;border:none;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0b111b;color:var(--muted);font-size:.85rem}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:16px}
    .card{grid-column:span 3;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;min-height:116px}
    .card h3{margin:0 0 6px 0;font-size:1rem}
    .metric{font-size:1.6rem;font-weight:800}
    .sub{color:var(--muted);font-size:.9rem}
    .half{grid-column:span 6}
    .wide{grid-column:span 12}
    .list{list-style:none;margin:0;padding:0}
    .list li{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed var(--border)}
    .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}

    @media (max-width:980px){ .card{grid-column:span 6} .half,.wide{grid-column:span 12} }
    @media (max-width:640px){ .card{grid-column:span 12} .hero h1{font-size:1.5rem} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="https://zbreeden.github.io/FourTwentyAnalytics/">‚Üê Back to Hub</a>
      <span class="badge">üõ°Ô∏è The Protector ‚Ä¢ Fire &amp; Safety Lens</span>
    </div>

    <section class="hero">
      <h1>üõ°Ô∏è The Protector ‚Äî Fire &amp; Safety</h1>
      <p>Monitor incidents, readiness, and response. This lens is tailored for Fire &amp; Security; cards can be swapped later when you shift this page to a Core-Systems homepage.</p>
      <div class="controls">
        <button id="run" class="btn">Run Check</button>
        <span class="pill">demo mode</span>
        <span class="pill">v0.1</span>
      </div>
    </section>

    <section class="grid" aria-label="Fire & Safety KPIs">
      <div class="card">
        <h3>Incidents (30d)</h3>
        <div id="incidents" class="metric">‚Äî</div>
        <div class="sub">Severity-weighted count</div>
      </div>
      <div class="card">
        <h3>High-Severity %</h3>
        <div id="sevHigh" class="metric">‚Äî</div>
        <div class="sub">High / total incidents</div>
      </div>
      <div class="card">
        <h3>Median Response Time</h3>
        <div id="response" class="metric">‚Äî</div>
        <div class="sub">Minutes to on-site or remote resolve</div>
      </div>
      <div class="card">
        <h3>Drill Compliance</h3>
        <div id="drill" class="metric">‚Äî</div>
        <div class="sub">% on schedule</div>
      </div>

      <div class="card">
        <h3>Asset Protection Score</h3>
        <div id="aps" class="metric">‚Äî</div>
        <div class="sub">0‚Äì100 model (config + maintenance)</div>
      </div>
      <div class="card">
        <h3>Preventive Health</h3>
        <div id="preventive" class="metric">‚Äî</div>
        <div class="sub">Overdue maintenance items</div>
      </div>
      <div class="card">
        <h3>False Alarm Rate</h3>
        <div id="falseRate" class="metric">‚Äî</div>
        <div class="sub">% of triggered events</div>
      </div>
      <div class="card">
        <h3>MTTR</h3>
        <div id="mttr" class="metric">‚Äî</div>
        <div class="sub">Mean time to recovery</div>
      </div>

      <div class="card half">
        <h3>Incident Mix</h3>
        <ul id="mix" class="list">
          <li><span>Loading‚Ä¶</span><span class="pill">‚Äî</span></li>
        </ul>
      </div>
      <div class="card half">
        <h3>Top Sites by Risk</h3>
        <ul id="sites" class="list">
          <li><span>Loading‚Ä¶</span><span class="pill">‚Äî</span></li>
        </ul>
      </div>

      <div class="card wide">
        <h3>Notes</h3>
        <div class="sub">
          This face is a **Fire & Safety lens** for interviews. Later you can pivot these tiles to Core-System KPIs
          (uptime, failed pulses, secrets hygiene) without changing the layout. Add a README to this repo and link it here:
          <a id="readme" href="#" target="_blank" rel="noopener">README</a> ‚Ä¢ <a id="readmeRaw" href="#" target="_blank" rel="noopener">raw</a>.
        </div>
      </div>
    </section>
  </div>

  <script>
async function loadCSV(url){
  const t = await fetch(url + '?t=' + Date.now(), {cache:'no-store'}).then(r=>r.text());
  const [h, ...rows] = t.trim().split('\n');
  const keys = h.split(','); 
  return rows.map(r => Object.fromEntries(r.split(',').map((v,i)=>[keys[i], v])));
}

async function hydrateFS(){
  const [inc, drills, maint, sites] = await Promise.all([
    loadCSV('./data/incidents.csv'),
    loadCSV('./data/drills.csv'),
    loadCSV('./data/maintenance.csv'),
    loadCSV('./data/sites.csv')
  ]);

  // helpers
  const within30d = (ts) => (Date.now() - new Date(ts).getTime())/86400000 <= 30;
  const recentInc = inc.filter(x => within30d(x.ts));
  const num = (x)=>Number(x)||0;

  // KPIs
  const total = recentInc.length;
  const high = recentInc.filter(x=>x.severity==='high').length;
  const responseMins = recentInc.filter(x=>x.response_min).map(x=>num(x.response_min)).sort((a,b)=>a-b);
  const median = responseMins.length ? responseMins[Math.floor(responseMins.length/2)] : 0;

  const byMonth = drills.reduce((m,x)=>{m[x.month]=m[x.month]||{sched:0,done:0}; m[x.month].sched+=num(x.scheduled); m[x.month].done+=num(x.completed); return m;},{});
  const latestMonth = Object.keys(byMonth).sort().pop();
  const drillPct = latestMonth ? Math.round((byMonth[latestMonth].done / Math.max(1,byMonth[latestMonth].sched))*100) : 0;

  const overdue = maint.filter(x => !x.completed_on && new Date(x.check_due) < new Date()).length;

  const falseRate = total ? Math.round(100 * recentInc.filter(x=>x.type==='system_fault' && x.severity==='low').length / total) : 0;

  const mttr = recentInc.filter(x=>x.resolved==='true').map(x=>num(x.response_min));
  const mttrAvg = mttr.length ? Math.round(mttr.reduce((a,b)=>a+b,0)/mttr.length) : 0;

  // Asset Protection Score: simple 0‚Äì100 demo model
  // base on guards, perimeter, overdue penalties
  const riskBySite = {};
  sites.forEach(s => {
    const guard = Number(s.has_guard) ? 0.85 : 0.65;
    const perim = Number(s.perimeter_quality || 0.5);
    const overduePenalty = maint.filter(m => m.site===s.site && !m.completed_on).length * 0.08;
    const score = Math.max(0, Math.min(1, (guard*0.5 + perim*0.5) - overduePenalty));
    riskBySite[s.site] = Math.round(score*100);
  });

  // Paint cards (matching ids from your current face)
  setMetric("incidents",  String(total), total>20 ? "warn" : "good");
  setMetric("sevHigh",    `${Math.round(100*high/Math.max(1,total))}%`, high/Math.max(1,total) > 0.15 ? "warn" : "good");
  setMetric("response",   `${median}m`,  median<=8 ? "good" : "warn");
  setMetric("drill",      `${drillPct}%`, drillPct>=90 ? "good" : "warn");
  setMetric("preventive", `${overdue} overdue`, overdue>0 ? "warn" : "good");
  setMetric("falseRate",  `${falseRate}%`, falseRate<=10 ? "good" : "warn");
  setMetric("mttr",       `${mttrAvg}m`, mttrAvg<=45 ? "good" : "warn");

  // Mix & Top Sites
  const mix = ['fire','intrusion','system_fault','other'];
  const mixCounts = mix.map(k => [labelize(k), recentInc.filter(x=>x.type===k).length]).filter(x=>x[1]>0);
  setList("mix", mixCounts.map(([k,v]) => [k, String(v)]));

  const topSites = Object.entries(riskBySite).sort((a,b)=>a[1]-b[1]).slice(0,4); // lowest scores = higher risk
  setList("sites", topSites.map(([site,score]) => [`${site}`, `risk ${100-score}`]));

  function labelize(k){ return k.replace('_',' ').replace(/\b\w/g,c=>c.toUpperCase()); }
}
// auto-run if Fire & Safety lens is your current page
hydrateFS().catch(console.error);
</script>

</body>
</html>
