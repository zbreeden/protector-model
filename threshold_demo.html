<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Threshold Tuner — Fraud Model</title>
  <style>
    :root { --bg:#0f1220; --card:#151833; --text:#e7e9f4; --muted:#a9acc4; --accent:#8ab4ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { padding: 20px 24px; border-bottom: 1px solid #283064; }
    h1 { margin: 0; font-size: 20px; }
    .sub { color: var(--muted); font-size: 13px; margin-top: 6px; }
    main { padding: 20px 24px; max-width: 1100px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-top: 16px; }
    .card { background: var(--card); border: 1px solid #283064; border-radius: 12px; padding: 14px; }
    .label { font-size: 12px; color: var(--muted); }
    .value { font-size: 22px; margin-top: 6px; font-variant-numeric: tabular-nums; }
    .value.small { font-size: 14px; }
    .row { display: flex; align-items: center; gap: 14px; }
    input[type="range"] { width: 100%; }
    .kpis { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-top: 12px; }
    .foot { margin-top: 20px; font-size: 12px; color: var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { text-align: right; padding: 8px; border-bottom: 1px dashed #2a3266; }
    th:first-child, td:first-child { text-align: left; }
    .chart { width: 100%; height: 220px; }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>Threshold Tuner — Fraud Model</h1>
    <div class="sub">Zero-install demo. Adjust threshold and watch KPIs update.</div>
  </header>
  <main>
    <div class="card">
      <div class="row">
        <div style="min-width:120px;"><span class="label">Threshold</span><div id="thVal" class="value mono">—</div></div>
        <input id="th" type="range" min="0" max="1" step="0.001" value="0.5" />
        <div style="min-width:160px;"><span class="label">Operating Point</span><div id="opPoint" class="value small mono muted">—</div></div>
      </div>
      <div class="kpis">
        <div class="card"><div class="label">Precision</div><div id="prec" class="value">—</div></div>
        <div class="card"><div class="label">Recall</div><div id="rec" class="value">—</div></div>
        <div class="card"><div class="label">F1</div><div id="f1" class="value">—</div></div>
        <div class="card"><div class="label">TP / FP</div><div id="tpfp" class="value small mono">—</div></div>
        <div class="card"><div class="label">TN / FN</div><div id="tnfn" class="value small mono">—</div></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="label">Precision–Recall Curve (from UI data)</div>
      <svg id="pr" class="chart" viewBox="0 0 600 220" preserveAspectRatio="none" aria-label="PR curve"></svg>
      <div class="foot">Data-driven from <span class="mono">ui.json</span>. If counts are present, KPIs are exact; otherwise they’re interpolated.</div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="label">Operating Points</div>
      <table id="tbl"><thead><tr>
        <th>Threshold</th><th>Precision</th><th>Recall</th><th>F1</th><th>TP</th><th>FP</th><th>TN</th><th>FN</th>
      </tr></thead><tbody></tbody></table>
    </div>

    <div class="foot">Drop this file next to <span class="mono">ui.json</span> and open in a browser. No Power BI. No Parallels.</div>
  </main>

  <script>
    const el = (id) => document.getElementById(id);
    const fmt = (x, d=3) => (x===null||x===undefined) ? "—" : (+x).toFixed(d);
    const f1 = (p, r) => (p+r) ? 2*p*r/(p+r) : 0;

    // Draw a simple PR curve
    function drawPR(points) {
      const svg = el('pr');
      svg.innerHTML = ""; // reset
      if (!points.length) return;
      const w = 600, h = 220, pad = 26;
      const xs = points.map(p => +p.recall);
      const ys = points.map(p => +p.precision);
      const xmin = 0, xmax = 1, ymin = 0, ymax = 1;
      const X = v => pad + (w-2*pad) * ( (v - xmin) / (xmax - xmin) );
      const Y = v => h - pad - (h-2*pad) * ( (v - ymin) / (ymax - ymin) );

      // Axes
      const ax = document.createElementNS("http://www.w3.org/2000/svg","path");
      ax.setAttribute("d", `M ${X(0)} ${Y(0)} L ${X(1)} ${Y(0)} M ${X(0)} ${Y(0)} L ${X(0)} ${Y(1)}`);
      ax.setAttribute("stroke", "#394285"); ax.setAttribute("fill","none");
      svg.appendChild(ax);

      // Ticks
      for (let t=0; t<=1.0001; t+=0.25){
        const vx = document.createElementNS("http://www.w3.org/2000/svg","line");
        vx.setAttribute("x1", X(t)); vx.setAttribute("x2", X(t));
        vx.setAttribute("y1", Y(0)-4); vx.setAttribute("y2", Y(0)+4);
        vx.setAttribute("stroke", "#394285"); svg.appendChild(vx);
        const vy = document.createElementNS("http://www.w3.org/2000/svg","line");
        vy.setAttribute("x1", X(0)-4); vy.setAttribute("x2", X(0)+4);
        vy.setAttribute("y1", Y(t)); vy.setAttribute("y2", Y(t));
        vy.setAttribute("stroke", "#394285"); svg.appendChild(vy);
      }

      // Line
      const d = points
        .sort((a,b)=>a.recall-b.recall)
        .map((p,i)=> (i? "L":"M") + " " + X(+p.recall) + " " + Y(+p.precision))
        .join(" ");
      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d", d);
      path.setAttribute("stroke", "#8ab4ff");
      path.setAttribute("fill","none");
      path.setAttribute("stroke-width","2");
      svg.appendChild(path);
    }

    function nearest(points, thr){
      // assumes points sorted by threshold
      let best = points[0];
      let minDiff = Infinity;
      for (const p of points){
        const diff = Math.abs(p.threshold - thr);
        if (diff < minDiff){ minDiff = diff; best = p; }
      }
      return best;
    }

    async function init(){
      let data;
      try {
        const res = await fetch('ui.json', {cache: 'no-store'});
        data = await res.json();
      } catch (e){
        data = { points: [], baseline: {} };
      }

      // Fallback: if only baseline provided, synthesize a tiny neighborhood
      if ((!data.points || !data.points.length) && data.baseline){
        const b = data.baseline;
        const t = +b.threshold ?? 0.5;
        const prec = +b.precision ?? 0, rec = +b.recall ?? 0;
        data.points = [
          { threshold: Math.max(0, t-0.1), precision: Math.max(0, prec*0.75), recall: Math.min(1, rec*1.05) },
          { threshold: t, precision: prec, recall: rec },
          { threshold: Math.min(1, t+0.1), precision: Math.min(1, prec*1.25), recall: Math.max(0, rec*0.9) },
        ];
      }

      // Build table
      const tbody = el('tbl').querySelector('tbody');
      tbody.innerHTML = "";
      const points = (data.points || []).slice().sort((a,b)=>a.threshold-b.threshold)
        .map(p => ({...p, f1: f1(+p.precision, +p.recall)}));
      for (const p of points){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="mono">${(+p.threshold).toFixed(3)}</td>
          <td>${fmt(p.precision,3)}</td>
          <td>${fmt(p.recall,3)}</td>
          <td>${fmt(p.f1,3)}</td>
          <td class="mono">${p.tp ?? "—"}</td>
          <td class="mono">${p.fp ?? "—"}</td>
          <td class="mono">${p.tn ?? "—"}</td>
          <td class="mono">${p.fn ?? "—"}</td>`;
        tbody.appendChild(tr);
      }

      drawPR(points);

      const slider = el('th');
      const thVal = el('thVal');
      const opPoint = el('opPoint');
      const prec = el('prec'), rec = el('rec'), f1el = el('f1'), tpfp = el('tpfp'), tnfn = el('tnfn');

      function update(){
        const t = +slider.value;
        thVal.textContent = t.toFixed(3);
        const p = nearest(points, t);
        opPoint.textContent = `nearest: ${(+p.threshold).toFixed(3)}`;
        prec.textContent = fmt(p.precision,3);
        rec.textContent = fmt(p.recall,3);
        f1el.textContent = fmt(p.f1,3);
        tpfp.textContent = `${p.tp ?? "—"} / ${p.fp ?? "—"}`;
        tnfn.textContent = `${p.tn ?? "—"} / ${p.fn ?? "—"}`;
      }

      // Initialize slider at baseline or first point
      const start = (data.baseline && typeof data.baseline.threshold === 'number')
        ? data.baseline.threshold
        : (points[0]?.threshold ?? 0.5);
      slider.value = start;
      update();
      slider.addEventListener('input', update);
    }

    init();
  </script>
</body>
</html>
